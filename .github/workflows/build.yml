name: CMake

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

env:
  BUILD_TYPE: Debug

jobs:
  build-linux:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        compiler: [gcc, clang]
        stdlib: [libstdc++, libc++]
        sqlite: [BUNDLED, SYSTEM, OFF]
        postgres: [BUNDLED, SYSTEM, OFF]
        mariadb: [BUNDLED, OFF]
        exclude:
        - compiler: gcc
          stdlib: libc++
        - stdlib: libc++
          sqlite: SYSTEM
        - stdlib: libc++
          postgres: SYSTEM

    name: ${{ matrix.compiler }}-${{ matrix.stdlib }}-sqlite(${{ matrix.sqlite }})-postgres(${{ matrix.postgres }})-mariadb(${{ matrix.mariadb }})

    steps:
    - name: Checkout repository and submodules
      uses: actions/checkout@v4
      with:
        submodules: true

    - name: Install toolchain
      id: install-toolchain
      uses: stormbytepp/install-toolchain@v1
      with:
        compiler: ${{ matrix.compiler }}

    - name: Install system dependencies (sqlite)
      if: ${{ matrix.sqlite == 'SYSTEM' }}
      run: |
        pkgs=""
        if [ "${{ matrix.sqlite }}" = "SYSTEM" ]; then pkgs="$pkgs libsqlite3-dev"; fi
        if [ -n "$pkgs" ]; then sudo apt-get install -y $pkgs; fi

    - name: Install system dependencies (postgres)
      if: ${{ matrix.postgres != 'OFF' }}
      run: |
        pkgs="meson bison flex libssl3"
        if [ "${{ matrix.postgres }}" = "SYSTEM" ]; then pkgs="$pkgs libpq-dev"; fi
        if [ -n "$pkgs" ]; then sudo apt-get install -y $pkgs; fi

    - name: Install system dependencies (mariadb)
      if: ${{ matrix.mariadb != 'OFF' }}
      run: |
        sudo apt-get update
        # Runtime libraries frequently required by libmariadb and its plugins
        pkgs="openssl libssl-dev libssl3 zlib1g libzstd1 liblz4-1 libcurl4"
        if [ -n "$pkgs" ]; then sudo apt-get install -y $pkgs; fi

    - name: Install and start Postgres server (Linux runners)
      if: ${{ matrix.postgres != 'OFF' }}
      run: |
        sudo apt-get update
        sudo apt-get install -y postgresql postgresql-contrib
        # Try service start (system packages start the service on install)
        sudo service postgresql start || true
        sleep 2
        # Create test role and database used by tests (idempotent)
        if ! sudo -u postgres psql -tAc "SELECT 1 FROM pg_roles WHERE rolname='testuser'" | grep -q 1; then
          sudo -u postgres psql -c "CREATE ROLE testuser WITH LOGIN PASSWORD 'testpass';"
        fi
        if ! sudo -u postgres psql -lqt | cut -d \| -f 1 | grep -qw stormbyte_test; then
          sudo -u postgres psql -c "CREATE DATABASE stormbyte_test OWNER testuser;"
        fi
        sudo -u postgres psql -c "ALTER ROLE testuser CREATEDB;" || true

    - name: Install and start MariaDB server (Linux runners)
      if: ${{ matrix.mariadb != 'OFF' }}
      run: |
        sudo apt-get update
        # Ensure runtime and TLS packages are present
        sudo apt-get install -y openssl libssl-dev libssl3 ca-certificates zlib1g libzstd1 liblz4-1 libcurl4 || true
        sudo apt-get install -y mariadb-server mariadb-client

        # Generate self-signed certs for MariaDB so the server supports TLS in CI
        sudo mkdir -p /etc/mysql/certs
        sudo openssl req -newkey rsa:2048 -nodes -x509 -days 365 \
          -subj "/CN=localhost" \
          -keyout /tmp/server-key.pem -out /tmp/server-cert.pem
        sudo mv /tmp/server-key.pem /etc/mysql/certs/server-key.pem
        sudo mv /tmp/server-cert.pem /etc/mysql/certs/server-cert.pem
        sudo chown -R mysql:mysql /etc/mysql/certs
        sudo chmod 600 /etc/mysql/certs/server-key.pem
        sudo chmod 644 /etc/mysql/certs/server-cert.pem

        # Ensure MariaDB loads the certs by adding a small config file
        sudo tee /etc/mysql/mariadb.conf.d/99-ci-ssl.cnf > /dev/null <<'EOF'
        [mysqld]
        ssl_cert=/etc/mysql/certs/server-cert.pem
        ssl_key=/etc/mysql/certs/server-key.pem
        ssl_ca=/etc/mysql/certs/server-cert.pem
        EOF

        # Start the service and wait until responsive
        sudo service mysql restart || sudo service mysql start || true
        sleep 2
        for i in 1 2 3 4 5 6 7 8 9 10; do
          if sudo mysqladmin ping >/dev/null 2>&1; then break; fi
          sleep 1
        done

        # Create test user and database (idempotent)
        sudo mysql -e "CREATE USER IF NOT EXISTS 'testuser'@'localhost' IDENTIFIED BY 'testpass';"
        sudo mysql -e "CREATE DATABASE IF NOT EXISTS stormbyte_test;"
        sudo mysql -e "GRANT ALL PRIVILEGES ON stormbyte_test.* TO 'testuser'@'localhost'; FLUSH PRIVILEGES;"

    - name: Build with CMake
      uses: ashutoshvarma/action-cmake-build@master
      with:
        build-dir: ${{ github.workspace }}/build
        cc: ${{ steps.install-toolchain.outputs.c_compiler }}
        cxx: ${{ steps.install-toolchain.outputs.cxx_compiler }}
        configure-options: >-
          -G Ninja
          -DENABLE_ASAN=ON
          -DENABLE_TEST=ON
          -DWITH_SQLITE=${{ matrix.sqlite }}
          -DWITH_POSTGRES=${{ matrix.postgres }}
          -DWITH_MARIADB=${{ matrix.mariadb }}
          -DWITH_STORMBYTE=BUNDLED
        build-type: ${{ env.BUILD_TYPE }}
        run-test: true
        ctest-options: --output-on-failure --test-dir ${{ github.workspace }}/build/test

  build-windows:
    runs-on: windows-latest
    strategy:
      matrix:
        arch:
          - x64

    steps:
      - name: Checkout repository and submodules
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Install toolchain
        id: install-toolchain
        uses: stormbytepp/install-toolchain@v1
        with:
          compiler: msvc
          arch: ${{ matrix.arch }}

      - name: Setup Python for Meson
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install Meson
        run: |
          python -m pip install --upgrade pip
          python -m pip install meson==1.9.2

      - name: Install win_flex_bison
        run: choco install winflexbison -y
        shell: powershell

      - name: Build with CMake
        uses: ashutoshvarma/action-cmake-build@master
        with:
          build-dir: ${{ github.workspace }}\build
          configure-options: >-
            -G Ninja
            -DENABLE_TEST=ON
            -DWITH_SQLITE=BUNDLED
            -DWITH_POSTGRES=BUNDLED
            -DWITH_MARIADB=BUNDLED
            -DWITH_STORMBYTE=BUNDLED
          build-type: ${{ env.BUILD_TYPE }}

      - name: Copy DLLs
        run: |
          Copy-Item -Path "${{ github.workspace }}\build\thirdparty\StormByte\base\lib\StormByte.dll" -Destination "${{ github.workspace }}\build\test" -Force
          Copy-Item -Path "${{ github.workspace }}\build\thirdparty\StormByte\logger\lib\StormByte-Logger.dll" -Destination "${{ github.workspace }}\build\test" -Force
          Copy-Item -Path "${{ github.workspace }}\build\thirdparty\sqlite3\sqlite3.dll" -Destination "${{ github.workspace }}\build\test" -Force
          Copy-Item -Path "${{ github.workspace }}\build\thirdparty\mariadb\mariadb-connector-c\libmariadb\libmariadb.dll" -Destination "${{ github.workspace }}\build\test" -Force
          Copy-Item -Path "${{ github.workspace }}\build\thirdparty\postgres\build\src\interfaces\libpq\libpq.dll" -Destination "${{ github.workspace }}\build\test" -Force
          Copy-Item -Path "${{ github.workspace }}\build\lib\StormByte-Database.dll" -Destination "${{ github.workspace }}\build\test" -Force

      - name: Install and start Postgres (Windows)
        shell: powershell
        run: |
          # Install PostgreSQL with known password and port so CI can connect reliably
          choco install postgresql18 --params '/Password:test /Port:5432 /AllowRemote' --ia '--enable-components server,commandlinetools' -y
          # Find installed PostgreSQL root (e.g. C:\Program Files\PostgreSQL\18)
          $pgroot = Get-ChildItem 'C:\Program Files\PostgreSQL' | Sort-Object Name -Descending | Select-Object -First 1
          if ($null -eq $pgroot) { Write-Host "Postgres not found under Program Files\PostgreSQL"; exit 0 }
          $pgroot = $pgroot.FullName
          $bindir = Join-Path $pgroot 'bin'
          $env:Path += ";$bindir"

          # Use the port and password we passed to choco
          $port = 5432
          $env:PGPASSWORD = 'test'

          # Rely on the service started by Chocolatey/installer. Wait until it's ready.
          $maxWait = 60
          $ready = $false
          for ($i = 0; $i -lt $maxWait; $i++) {
            try {
              & psql.exe -U postgres -h localhost -p $port -c "SELECT 1;" > $null 2>&1
              if ($LASTEXITCODE -eq 0) { $ready = $true; break }
            } catch {
            }
            Start-Sleep -Seconds 1
          }
          if (-not $ready) { Write-Host "Postgres did not become ready on port $port"; exit 1 }

          # Create test role and database (idempotent) using the running service
          $exists = & psql.exe -U postgres -h localhost -p $port -t -c "SELECT 1 FROM pg_roles WHERE rolname='testuser';" | Out-String
          if ($exists -notmatch '1') { & psql.exe -U postgres -h localhost -p $port -c "CREATE ROLE testuser WITH LOGIN PASSWORD 'testpass';" }
          $dbs = & psql.exe -U postgres -h localhost -p $port -lqt | Out-String
          if ($dbs -notmatch 'stormbyte_test') { & psql.exe -U postgres -h localhost -p $port -c "CREATE DATABASE stormbyte_test OWNER testuser;" }

      - name: Install and start MariaDB (Windows)
        shell: powershell
        run: |
            # Install MariaDB via Chocolatey and set root password
              choco install mariadb --params '/RootPassword:test' -y
              # Refresh environment variables so PATH updates from Chocolatey take effect
              try { refreshenv } catch { Write-Host "refreshenv not available or failed; continuing" }

              # Try to locate mysql.exe robustly
              $mysqlCmd = Get-Command mysql.exe -ErrorAction SilentlyContinue
              if ($null -eq $mysqlCmd) {
                $mdb = Get-ChildItem 'C:\Program Files' -Directory -Filter 'MariaDB*' -ErrorAction SilentlyContinue | Sort-Object Name -Descending | Select-Object -First 1
                if ($null -ne $mdb) { $bindir = Join-Path $mdb.FullName 'bin'; $env:Path += ";$bindir" }
                $mysqlCmd = Get-Command mysql.exe -ErrorAction SilentlyContinue
              }
              if ($null -eq $mysqlCmd) { Write-Host "mysql.exe not found; aborting MariaDB setup"; exit 1 }
              $mysqlPath = $mysqlCmd.Source

              # Try to connect as root with no password first
              $connected = $false
              try {
                & $mysqlPath -u root -e "SELECT 1;" > $null 2>&1
                if ($LASTEXITCODE -eq 0) { $connected = $true }
              } catch {
              }

              # If not connected, try with environment password 'test'
              if (-not $connected) {
                $env:MYSQL_PWD = 'test'
                try {
                  & $mysqlPath -u root -e "SELECT 1;" > $null 2>&1
                  if ($LASTEXITCODE -eq 0) { $connected = $true }
                } catch {
                }
              }

              # If still not connected, try to set root password to 'test' (assume blank current password)
              if (-not $connected) {
                $mysqlDir = Split-Path $mysqlPath
                $mysqladminPath = Join-Path $mysqlDir 'mysqladmin.exe'
                if (Test-Path $mysqladminPath) {
                  try {
                    & $mysqladminPath -u root password test > $null 2>&1
                  } catch {
                  }
                  # give server a moment and then try with the new password
                  Start-Sleep -Seconds 2
                  $env:MYSQL_PWD = 'test'
                  try {
                    & $mysqlPath -u root -e "SELECT 1;" > $null 2>&1
                    if ($LASTEXITCODE -eq 0) { $connected = $true }
                  } catch {
                  }
                }
              }

              # If still not connected, perform the longer wait loop using whatever $env:MYSQL_PWD is set to
              if (-not $connected) {
                $ready = $false
                for ($i = 0; $i -lt 120; $i++) {
                  try {
                    & $mysqlPath -u root -e "SELECT 1;" > $null 2>&1
                    if ($LASTEXITCODE -eq 0) { $ready = $true; break }
                  } catch {
                  }
                  Start-Sleep -Seconds 1
                }
                if (-not $ready) { Write-Host "MariaDB did not become ready"; exit 1 }
              }

              # Create test user and database; use env password if set
              & $mysqlPath -u root -e "CREATE USER IF NOT EXISTS 'testuser'@'localhost' IDENTIFIED BY 'testpass';"
              & $mysqlPath -u root -e "CREATE DATABASE IF NOT EXISTS stormbyte_test;"
              & $mysqlPath -u root -e "GRANT ALL PRIVILEGES ON stormbyte_test.* TO 'testuser'@'localhost'; FLUSH PRIVILEGES;"

      - name: Run unit tests
        run: ctest --output-on-failure --test-dir ${{ github.workspace }}\build\test
